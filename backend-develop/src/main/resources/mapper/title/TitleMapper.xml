<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yumyumcoach.domain.title.mapper.TitleMapper">

    <!-- 내가 보유한 타이틀인지 여부 -->
    <select id="ownsTitle" resultType="boolean">
        SELECT EXISTS(
            SELECT 1
            FROM account_titles
            WHERE email = #{email}
              AND title_id = #{titleId}
        )
    </select>

    <!-- 현재 대표 타이틀 조회 -->
    <select id="findCurrentTitle" resultType="com.yumyumcoach.domain.title.dto.MyTitleResponse">
        SELECT
            p.display_title_id AS currentTitleId,
            t.name AS currentTitleName
        FROM profiles p
        LEFT JOIN titles t
        ON t.id = p.display_title_id
        WHERE p.email = #{email}
    </select>

    <!-- 내가 보유한 타이틀 목록 -->
    <select id="findMyTitles" parameterType="string"
            resultType="com.yumyumcoach.domain.title.dto.MyTitleItemResponse">
        SELECT
            t.id AS titleId,
            t.icon_emoji AS iconEmoji,
            t.name AS name,
            t.description AS description,
            at.obtained_at AS obtainedAt,
            at.source_challenge_id AS sourceChallengeId,
            CASE cr.difficulty_code
                WHEN 'BEGINNER' THEN '초급'
                WHEN 'INTERMEDIATE' THEN '중급'
                WHEN 'ADVANCED' THEN '고급'
                ELSE NULL
                END AS difficultyName
        FROM account_titles at
    JOIN titles t ON t.id = at.title_id
            LEFT JOIN challenge_rules cr
            ON cr.challenge_id = at.source_challenge_id
            AND cr.reward_title_id = at.title_id
        WHERE at.email = #{email}
        ORDER BY at.obtained_at DESC
    </select>

</mapper>
