<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yumyumcoach.domain.auth.mapper.RefreshTokenMapper">

    <insert id="upsert">
        INSERT INTO refresh_tokens (email, token_hash, expires_at, created_at)
        VALUES (#{email}, #{tokenHash}, #{expiresAt}, NOW())
            ON DUPLICATE KEY UPDATE
                                 token_hash = VALUES(token_hash),
                                 expires_at = VALUES(expires_at)
    </insert>

    <select id="findByEmail" resultType="com.yumyumcoach.domain.auth.entity.RefreshToken">
        SELECT email,
               token_hash AS tokenHash,
               expires_at AS expiresAt,
               created_at AS createdAt
        FROM refresh_tokens
        WHERE email = #{email}
    </select>

    <select id="findByEmailAndHash" resultType="com.yumyumcoach.domain.auth.entity.RefreshToken">
        SELECT email,
               token_hash AS tokenHash,
               expires_at AS expiresAt,
               created_at AS createdAt
        FROM refresh_tokens
        WHERE email = #{email}
          AND token_hash = #{tokenHash}
    </select>

    <delete id="deleteByEmailAndHash">
        DELETE FROM refresh_tokens
        WHERE email = #{email}
          AND token_hash = #{tokenHash}
    </delete>

    <delete id="deleteByEmail">
        DELETE FROM refresh_tokens
        WHERE email = #{email}
    </delete>

    <delete id="deleteExpired">
        DELETE FROM refresh_tokens
        WHERE expires_at &lt; NOW()
    </delete>

</mapper>